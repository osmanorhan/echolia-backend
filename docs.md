# Mobile Integration API Guide

This document summarizes every HTTP endpoint the mobile client must call and how to use it. Base URLs:

- Development: `http://localhost:8000`
- Production: `https://api.echolia.com`

Unless noted otherwise, send `Accept: application/json` and include `Authorization: Bearer {access_token}` headers generated by `/auth/oauth/signin`.

## Service Status

| Method | Path | Auth | Purpose |
| --- | --- | --- | --- |
| GET | `/` | No | Returns `{ service, version, status, environment }` so the client can confirm cluster + version before starting auth. |
| GET | `/health` | No | Lightweight health signal `{ status, database }` used for diagnostics/watchdogs. |

## Authentication

### POST `/auth/oauth/signin`

- Input: `{ provider: "google"|"apple", id_token, device_id, device_name, platform, app_version? }`
- Output: `{ access_token, refresh_token, token_type, expires_in, user_id, add_ons }`
- Server validates the `id_token` with Google/Apple, upserts the user/device, and returns fresh JWTs that expire in 1 hour (access) / 30 days (refresh). Store `add_ons.ai_enabled` for gating the AI feature.

### POST `/auth/refresh`

- Input: `{ refresh_token }`
- Output: Same schema as sign-in. Both tokens rotate on refresh; use this endpoint silently whenever you receive `401` from a protected call.
- Errors: `401` if the refresh token is invalid/expired; prompt re-auth.

### GET `/auth/me`

- Returns `{ user_id, provider, email?, name?, created_at, add_ons }`.
- Call right after sign-in to hydrate profile data or whenever you need fresh add-on status.

### GET `/auth/devices`

- Returns `{"devices": DeviceInfo[]}` where each entry contains `{ device_id, device_name, platform, app_version?, last_seen_at, created_at }`.
- Use to present device management UI or to identify `targetDeviceId` for revocation.

### DELETE `/auth/device/{device_id}`

- Revokes the specified device. Server rejects deleting the currently active device (`400`) and returns `404` when the ID doesn’t exist.
- No body required; successful response is `{ success: true, message: "Device deleted successfully" }`.

## LLM Proxy

Every LLM endpoint requires authentication. Tier logic:

- Free tier: 10 requests/day, all models allowed.
- AI Add-on: 500 requests/hour, 5000/day, fair-usage enforced.

### POST `/llm/generate`

- Input model (`model`), prompt (`input`), and optional context metadata.
- Server enforces tier limits and reroutes to the configured foundation model.
- Errors: `429` when limits exceeded, `503` when the target model is missing credentials, `400` for bad input.

### GET `/llm/models`

- Returns `{ models: [...] }` describing every available model and tier availability. Use it to populate a model picker or decide defaults.

### GET `/llm/usage`

- Returns `{ tier, today: { used, remaining, limit }, lifetime: { total_requests, total_tokens } }`.
- Show this in settings to drive upsell messaging or warn free users before they hit the cap.

## Integration Tips

1. **Token Storage**: Keep tokens in secure storage; rotate via `/auth/refresh` before expiry.
2. **Error Handling**: Treat `401` as “refresh or re-auth”, `429` as “show rate-limit message”, `503` as “temporarily unavailable”.
3. **Environment Switching**: Use the Bruno collection in `bruno/echolia-api` with the provided environments to test these flows manually.
4. **Device Metadata**: Always send stable `device_id` + `device_name` on sign-in to keep device management accurate.
